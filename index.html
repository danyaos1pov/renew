// Пример обработки в AppScript
const SHEET_NAME = "Users";

function doGet(e) { return handleRequest(e); }
function doPost(e) { return handleRequest(e); }

function handleRequest(e) {
  const sheet = SpreadsheetApp.getActive().getSheetByName(SHEET_NAME);
  const uid = e.parameter.uid || JSON.parse(e.postData.contents).uid;

  if (e.parameter.action === "get" || e.postData?.contents.includes("get")) {
    const row = findUserRow(sheet, uid);
    if (!row) {
      return ContentService.createTextOutput(JSON.stringify({status: "new"}));
    }
    const data = sheet.getRange(row, 1, 1, 10).getValues()[0];
    return ContentService.createTextOutput(JSON.stringify({
      status: "exists", limit: data[1], used: data[10] || 0,
      gift: data[2], gift2: data[3], gift3: data[4], gift4: data[5]
    }));
  }

  if (e.parameter.action === "save" || JSON.parse(e.postData.contents).action === "save") {
    const gift = e.parameter.gift || JSON.parse(e.postData.contents).gift;
    let row = findUserRow(sheet, uid);
    if (!row) {
      row = sheet.getLastRow() + 1;
      sheet.getRange(row, 1).setValue(uid);
      sheet.getRange(row, 2).setValue(1); // limit
    }
    const used = (sheet.getRange(row, 11).getValue() || 0) + 1;
    sheet.getRange(row, 11).setValue(used);

    // Записываем подарок в первую свободную ячейку C-F (3-6)
    for (let col = 3; col <= 6; col++) {
      if (!sheet.getRange(row, col).getValue()) {
        sheet.getRange(row, col).setValue(gift);
        break;
      }
    }
    return ContentService.createTextOutput(JSON.stringify({status: "ok"}));
  }
}

function findUserRow(sheet, uid) {
  const ids = sheet.getRange("A2:A").getValues().flat();
  const index = ids.indexOf(Number(uid) || uid);
  return index >= 0 ? index + 2 : null;
}
