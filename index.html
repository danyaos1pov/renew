<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello, ON1X</title>
    <meta name="theme-color" content="#000000">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        body {margin:0;padding:20px;min-height:100dvh;background:#000;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;justify-content:center;}
        .card {background:#111;padding:35px;border-radius:24px;width:90%;max-width:420px;text-align:center;box-shadow:0 15px 50px rgba(0,0,0,0.7);}
        h1 {margin:0 0 30px;font-size:30px;background:linear-gradient(90deg,#00ff9d,#00b8ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        input {width:100%;padding:18px;font-size:20px;margin:15px 0;border:none;border-radius:16px;background:#222;color:#fff;text-align:center;}
        input[disabled] {opacity:0.8;cursor:not-allowed;}
        .status {margin-top:20px;font-size:16px;opacity:0.8;}
        .found {color:#00ff9d;}
        .notfound {color:#ff6b6b;}
        .error {color:#ff6b6b; font-weight: bold;}
    </style>
</head>
<body>

<div class="card">
    <h1>Hello, ON1X</h1>
    <input type="text" id="keyInput" disabled placeholder="–ò—â–µ–º –≤–∞—à –∫–ª—é—á...">
    <div class="status" id="status">–ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
</div>

<script>
    console.log('üöÄ Mini App –∑–∞–ø—É—â–µ–Ω!');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Supabase
    const supabaseUrl = 'https://drrpeeoaatepcrzgoqud.supabase.co';
    const supabaseKey = 'sb_publishable_9SVDXXIMUGzPVfmC7OwBIg_94SYwcW6';
    
    console.log('üîó Supabase URL:', supabaseUrl);
    console.log('üîë Supabase Key (–ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤):', supabaseKey.substring(0, 10) + '...');
    
    let supabase;
    try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        console.log('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞:', error);
        document.getElementById('status').innerHTML = '<span class="error">–û—à–∏–±–∫–∞ Supabase: ' + error.message + '</span>';
        throw error;
    }

    // Telegram
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    console.log('üì± Telegram WebApp –≥–æ—Ç–æ–≤');

    const user = tg.initDataUnsafe?.user;
    console.log('üë§ Telegram User:', user);

    if (!user?.id) {
        console.error('‚ùå –ù–µ—Ç Telegram ID');
        document.getElementById('status').innerHTML = '<span class="notfound">–û—à–∏–±–∫–∞: –ù–µ—Ç Telegram ID</span>';
        return;
    }

    const telegramId = user.id.toString();
    console.log('üÜî –í–∞—à Telegram ID:', telegramId);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–∞
    async function loadKey() {
        console.log('üîç –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫ –∫–ª—é—á–∞ –¥–ª—è ID:', telegramId);
        
        const status = document.getElementById('status');
        status.innerHTML = '–ò—â–µ–º... (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Å–æ–ª—å F12)';

        try {
            const { data, error } = await supabase
                .from('Hello, ON1X')
                .select('Key')
                .eq('TG ID', telegramId)
                .maybeSingle();

            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:', { data, error });

            const input = document.getElementById('keyInput');

            if (error) {
                console.error('‚ùå Supabase –æ—à–∏–±–∫–∞:', error);
                if (error.code === 'PGRST116') { // –ù–µ—Ç –∑–∞–ø–∏—Å–∏
                    input.value = '‚Äî';
                    status.innerHTML = '<span class="notfound">–í—ã –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</span>';
                } else if (error.message.includes('invalid') || error.message.includes('project')) {
                    input.value = '‚Äî';
                    status.innerHTML = '<span class="error">–ù–µ–≤–µ—Ä–Ω—ã–π Supabase URL/–∫–ª—é—á! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</span>';
                } else {
                    status.innerHTML = '<span class="error">–û—à–∏–±–∫–∞: ' + error.message + '</span>';
                }
                return;
            }

            if (data?.Key) {
                input.value = data.Key.trim();
                status.innerHTML = '<span class="found">–ö–ª—é—á –Ω–∞–π–¥–µ–Ω!</span>';
                console.log('‚úÖ –ö–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω:', data.Key);
            } else {
                input.value = '‚Äî';
                status.innerHTML = '<span class="notfound">–í—ã –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ ID –≤ –∫–æ–Ω—Å–æ–ª–∏)</span>';
                console.log('‚ÑπÔ∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è ID:', telegramId);
            }
        } catch (err) {
            console.error('üí• –û–±—â–∞—è –æ—à–∏–±–∫–∞:', err);
            status.innerHTML = '<span class="error">–û–±—â–∞—è –æ—à–∏–±–∫–∞: ' + err.message + '</span>';
        }
    }

    // –ó–∞–ø—É—Å–∫
    loadKey();
</script>

</body>
</html>
