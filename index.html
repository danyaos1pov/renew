<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Новогодний дроп 2026</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{min-height:100vh;background:#000;color:#fff;font-family:'Inter',sans-serif;display:flex;flex-direction:column;overflow:hidden;position:relative;}
    body::before{content:'';position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#6e00ff 0%,#00d4ff 50%,transparent 70%);filter:blur(120px);opacity:0.4;animation:breathe 12s infinite alternate;}
    @keyframes breathe{0%{transform:scale(1)}100%{transform:scale(1.3)}}
    .container{padding:20px;text-align:center;z-index:2;}
    h1{font-size:2.8rem;font-weight:700;background:linear-gradient(120deg,#fff,#a0a0ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px;}
    p{font-size:1.1rem;opacity:0.7;margin-bottom:20px;}
    .info{margin:15px 0;font-size:0.95rem;opacity:0.8;}
    .btn{margin-top:20px;padding:14px 32px;background:linear-gradient(90deg,#7928ff,#00e0ff);color:white;border:none;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;box-shadow:0 8px 25px rgba(121,40,255,0.4);}
    .btn:hover{transform:translateY(-3px);}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;max-width:400px;margin:40px auto 0;display:none;}
    .card{aspect-ratio:1;background:rgba(255,255,255,0.06);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:4rem;cursor:pointer;backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.1);transition:all 0.4s;}
    .card:hover{transform:translateY(-16px) scale(1.05);box-shadow:0 30px 60px rgba(0,0,0,0.5);}
    .card.selected{background:linear-gradient(135deg,#7928ff,#00e0ff);transform:scale(1.15);box-shadow:0 0 80px rgba(121,40,255,0.6);}
    .card.disabled{opacity:0.3;pointer-events:none;}
    .modal,.gifts-modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;opacity:0;visibility:hidden;transition:all 0.6s;}
    .modal.show,.gifts-modal.show{opacity:1;visibility:visible;}
    .modal h2,.gifts-modal h2{font-size:3.2rem;font-weight:700;margin-bottom:20px;background:linear-gradient(120deg,#ff00c8,#00ffff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .prize{font-size:1.8rem;padding:18px 36px;background:rgba(255,255,255,0.08);border-radius:20px;margin:15px 0;}
    .gifts-list .prize{font-size:1.6rem;margin:12px 0;}
    .text{font-size:1.4rem;opacity:0.9;margin:20px 0 40px;}
    button{padding:18px 60px;font-size:1.3rem;font-weight:600;background:linear-gradient(90deg,#7928ff,#00e0ff);color:white;border:none;border-radius:50px;cursor:pointer;box-shadow:0 10px 30px rgba(121,40,255,0.4);}
    button:hover{transform:translateY(-4px);}
  </style>
</head>
<body>

  <div class="container">
    <h1>Новогодний дроп 2026</h1>
    <p id="status">Загрузка...</p>
    <div class="info">Осталось попыток: <strong id="attempts">-</strong></div>
    <button onclick="showGifts()" class="btn">Мои подарки</button>
    <div class="grid" id="grid"></div>
  </div>

  <div class="modal" id="modal">
    <h2 id="title">Приз получен!</h2>
    <div class="prize" id="prize"></div>
    <div class="text">Ожидайте получения подарка</div>
    <button onclick="closeModal()">Хорошо</button>
  </div>

  <div class="gifts-modal" id="giftsModal">
    <h2>Твои подарки</h2>
    <div class="gifts-list" id="giftsList">
      <p style="opacity:0.7">У тебя пока нет подарков</p>
    </div>
    <button onclick="closeGiftsModal()">Закрыть</button>
  </div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const USER_ID = Telegram.WebApp.initDataUnsafe.user?.id?.toString() || "test_" + Date.now();
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNPFeM8iB45G8OzG7Phh9ekFeGk2V5IlQs63KlUQ_vIClGWTs-w7TMf-fIPVVFMJ1W/exec";

    const prizes = ["1000 ₽","Стикерпак 2026","7 дней Premium","Эксклюзивный аватар","500 ₽","iPhone 16 Pro Max","300 ₽","3 дня Premium","Видео-поздравление"];
    const winner = Math.floor(Math.random() * 9);

    let currentGifts = [];

    async function loadState() {
      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "check", userId: USER_ID }),
          headers: { "Content-Type": "text/plain" }
        });
        const data = await res.json();

        if (data.error) {
          document.getElementById("status").textContent = data.error;
          return;
        }

        document.getElementById("attempts").textContent = data.attempts || 0;
        currentGifts = data.gifts || [];

        if (data.attempts > 0) {
          document.getElementById("status").textContent = "Выбери свой подарок!";
          document.getElementById("grid").style.display = "grid";
          createCards();
        } else {
          document.getElementById("status").textContent = "Попытки закончились";
          document.getElementById("grid").style.display = "none";
        }
      } catch (e) {
        document.getElementById("status").textContent = "Ошибка сети";
      }
    }

    function createCards() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        const card = document.createElement("div");
        card.className = "card";
        card.textContent = "Gift";
        card.onclick = () => chooseGift(card, i);
        grid.appendChild(card);
      }
    }

    async function chooseGift(card, index) {
      if (card.classList.contains("selected")) return;

      document.querySelectorAll(".card").forEach(c => c.classList.add("disabled"));
      card.classList.add("selected");

      const prize = prizes[index];
      const isMain = index === winner;

      const resp = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "claim", userId: USER_ID, prize: prize }),
        headers: { "Content-Type": "text/plain" }
      });
      const result = await resp.json();

      if (result.error) {
        alert("Ошибка: " + result.error);
        location.reload();
        return;
      }

      currentGifts = result.gifts || currentGifts;

      setTimeout(() => {
        document.getElementById("title").textContent = isMain ? "Главный приз!" : "Приз получен!";
        document.getElementById("prize").textContent = prize + (isMain ? " Jackpot" : "");
        document.getElementById("modal").classList.add("show");
      }, 800);
    }

    function closeModal() {
      document.getElementById("modal").classList.remove("show");
      loadState();
    }

    function showGifts() {
      const list = document.getElementById("giftsList");
      if (currentGifts.length === 0) {
        list.innerHTML = "<p style='opacity:0.7'>У тебя пока нет подарков</p>";
      } else {
        list.innerHTML = currentGifts.map(g => `<div class="prize">${g}</div>`).join("");
      }
      document.getElementById("giftsModal").classList.add("show");
    }

    function closeGiftsModal() {
      document.getElementById("giftsModal").classList.remove("show");
    }

    loadState();
  </script>
</body>
</html>
