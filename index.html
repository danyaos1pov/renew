<script>
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  const USER_ID = Telegram.WebApp.initDataUnsafe.user?.id?.toString() || "test_" + Date.now();
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNPFeM8iB45G8OzG7Phh9ekFeGk2V5IlQs63KlUQ_vIClGWTs-w7TMf-fIPVVFMJ1W/exec";

  const prizes = ["1000 ₽","Стикерпак 2026","7 дней Premium","Эксклюзивный аватар","500 ₽","iPhone 16 Pro Max","300 ₽","3 дня Premium","Видео-поздравление"];
  const winner = Math.floor(Math.random() * 9);

  async function loadState() {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "check", userId: USER_ID }),
        headers: { "Content-Type": "text/plain" }
      });
      const data = await res.json();

      if (data.error) {
        document.getElementById("status").textContent = data.error;
        return;
      }

      const attempts = data.attempts || 0;
      document.getElementById("attempts").textContent = attempts;

      if (attempts > 0) {
        document.getElementById("status").textContent = "Выбери свой подарок!";
        document.getElementById("grid").style.display = "grid";
        createCards();
      } else {
        document.getElementById("status").textContent = "Попытки закончились";
        document.getElementById("grid").style.display = "none";
      }
    } catch (e) {
      document.getElementById("status").textContent = "Ошибка сети";
    }
  }

  function createCards() {
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    for (let i = 0; i < 9; i++) {
      const card = document.createElement("div");
      card.className = "card";
      card.textContent = "Gift";
      card.onclick = () => chooseGift(card, i);
      grid.appendChild(card);
    }
  }

  async function chooseGift(card, index) {
    if (card.classList.contains("selected")) return;

    document.querySelectorAll(".card").forEach(c => c.classList.add("disabled"));
    card.classList.add("selected");

    const prize = prizes[index];
    const isMain = index === winner;

    const resp = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({ action: "claim", userId: USER_ID, prize: prize }),
      headers: { "Content-Type": "text/plain" }
    });
    const result = await resp.json();

    if (result.error) {
      alert("Ошибка: " + result.error);
      location.reload();
      return;
    }

    setTimeout(() => {
      document.getElementById("title").textContent = isMain ? "Главный приз!" : "Приз получен!";
      document.getElementById("prize").textContent = prize + (isMain ? " Jackpot" : "");
      document.getElementById("modal").classList.add("show");
    }, 800);
  }

  document.getElementById("okBtn").onclick = () => {
    document.getElementById("modal").classList.remove("show");
    loadState(); // ← обновляем состояние
  };

  loadState();
</script>
